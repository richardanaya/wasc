<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WASC - WebAssembly Compiler & Runner</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #1e1e1e;
            color: #d4d4d4;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        header {
            background: #2d2d30;
            padding: 1rem 2rem;
            border-bottom: 1px solid #3e3e42;
        }
        
        h1 {
            font-size: 1.5rem;
            color: #4ec9b0;
        }
        
        .subtitle {
            color: #808080;
            font-size: 0.9rem;
            margin-top: 0.25rem;
        }
        
        main {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 1px;
            background: #3e3e42;
        }
        
        @media (max-width: 768px) {
            main {
                grid-template-columns: 1fr;
                grid-template-rows: 1fr 1fr 1fr 1fr;
            }
        }
        
        .panel {
            background: #1e1e1e;
            display: flex;
            flex-direction: column;
            min-height: 200px;
        }
        
        .panel-header {
            background: #2d2d30;
            padding: 0.5rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #3e3e42;
        }
        
        .panel-title {
            font-size: 0.9rem;
            color: #cccccc;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .panel-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        button {
            background: #0e639c;
            color: white;
            border: none;
            padding: 0.4rem 1rem;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: background 0.2s;
        }
        
        button:hover {
            background: #1177bb;
        }
        
        button:disabled {
            background: #3e3e42;
            cursor: not-allowed;
        }
        
        button.secondary {
            background: #3e3e42;
        }
        
        button.secondary:hover {
            background: #4e4e52;
        }
        
        button.success {
            background: #4ec9b0;
        }
        
        button.success:hover {
            background: #3da892;
        }
        
        .panel-content {
            flex: 1;
            position: relative;
            overflow: hidden;
        }
        
        textarea, .output {
            width: 100%;
            height: 100%;
            background: #1e1e1e;
            color: #d4d4d4;
            border: none;
            padding: 1rem;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
            resize: none;
            outline: none;
        }
        
        .output {
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }
        
        .error {
            color: #f48771;
        }
        
        .success {
            color: #4ec9b0;
        }
        
        .info {
            color: #569cd6;
        }
        
        .warning {
            color: #dcdcaa;
        }
        
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #808080;
        }
        
        .examples {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .example-btn {
            background: #252526;
            border: 1px solid #3e3e42;
            color: #9cdcfe;
            padding: 0.3rem 0.8rem;
            font-size: 0.8rem;
        }
        
        .example-btn:hover {
            background: #2d2d30;
            border-color: #4e4e52;
        }
        
        .runtime-section {
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid #3e3e42;
        }
        
        .function-call {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
            align-items: center;
        }
        
        .function-call input {
            background: #2d2d30;
            border: 1px solid #3e3e42;
            color: #d4d4d4;
            padding: 0.3rem;
            border-radius: 3px;
            font-family: inherit;
        }
        
        .log-entry {
            margin: 0.25rem 0;
            padding: 0.25rem 0.5rem;
            background: #252526;
            border-left: 3px solid #4ec9b0;
        }
    </style>
</head>
<body>
    <header>
        <h1>WASC Compiler & Runtime</h1>
        <div class="subtitle">Compile C-like code to WebAssembly and run it in your browser</div>
    </header>
    
    <main>
        <div class="panel">
            <div class="panel-header">
                <span class="panel-title">Source Code</span>
                <div class="examples">
                    <button class="example-btn secondary" onclick="loadExample('simple')">Simple</button>
                    <button class="example-btn secondary" onclick="loadExample('refs')">References</button>
                    <button class="example-btn secondary" onclick="loadExample('console')">Console</button>
                    <button class="example-btn secondary" onclick="loadExample('add')">Add</button>
                </div>
            </div>
            <div class="panel-content">
                <textarea id="source" placeholder="// Enter your wasc code here
// Example:
export i32 main() {
    return 42;
}">export i32 main() {
    return 42;
}</textarea>
            </div>
        </div>
        
        <div class="panel">
            <div class="panel-header">
                <span class="panel-title">Compilation Output</span>
                <div class="panel-actions">
                    <button id="compileBtn" onclick="compile()">Compile</button>
                    <button class="secondary" onclick="downloadWasm()" id="downloadBtn" disabled>Download</button>
                </div>
            </div>
            <div class="panel-content">
                <div id="output" class="output">
                    <div class="loading">Click "Compile" to generate WebAssembly</div>
                </div>
            </div>
        </div>
        
        <div class="panel">
            <div class="panel-header">
                <span class="panel-title">Runtime</span>
                <div class="panel-actions">
                    <button class="success" onclick="runWasm()" id="runBtn" disabled>▶ Run WASM</button>
                </div>
            </div>
            <div class="panel-content">
                <div id="runtime" class="output">
                    <div class="loading">Compile first, then run the WASM module</div>
                </div>
            </div>
        </div>
        
        <div class="panel">
            <div class="panel-header">
                <span class="panel-title">Execution Log</span>
                <div class="panel-actions">
                    <button class="secondary" onclick="clearLog()">Clear</button>
                </div>
            </div>
            <div class="panel-content">
                <div id="log" class="output">
                    <span class="info">Execution log will appear here...</span>
                </div>
            </div>
        </div>
    </main>

    <script type="module">
        import init, { compile_wasm } from './wasc.js';
        
        let wasmModule = null;
        let lastCompiledBytes = null;
        let wasmInstance = null;
        
        // Initialize WASM
        async function initWasm() {
            try {
                await init();
                wasmModule = { compile_wasm };
                document.getElementById('output').innerHTML = '<span class="info">✓ WASC compiler loaded and ready</span>';
            } catch (e) {
                document.getElementById('output').innerHTML = `<span class="error">Error loading compiler: ${e.message}</span>`;
                console.error(e);
            }
        }
        
        // Compile function
        window.compile = async function() {
            if (!wasmModule) {
                document.getElementById('output').innerHTML = '<span class="error">Compiler not loaded yet</span>';
                return;
            }
            
            const source = document.getElementById('source').value;
            const output = document.getElementById('output');
            const downloadBtn = document.getElementById('downloadBtn');
            const runBtn = document.getElementById('runBtn');
            
            // Reset runtime state
            wasmInstance = null;
            runBtn.disabled = true;
            
            output.innerHTML = '<span class="info">Compiling...</span>';
            
            try {
                const bytes = wasmModule.compile_wasm(source);
                lastCompiledBytes = bytes;
                
                // Display success info
                const size = bytes.length;
                const hexPreview = Array.from(bytes.slice(0, 32))
                    .map(b => b.toString(16).padStart(2, '0'))
                    .join(' ');
                
                // Decode to get imports/exports info
                const wasmModuleInfo = await WebAssembly.compile(bytes);
                const imports = WebAssembly.Module.imports(wasmModuleInfo);
                const exports = WebAssembly.Module.exports(wasmModuleInfo);
                
                output.innerHTML = `<span class="success">✓ Compilation successful!</span>

<span class="info">Size:</span> ${size} bytes
<span class="info">Hex preview:</span> ${hexPreview}${size > 32 ? '...' : ''}

<span class="info">Imports (${imports.length}):</span>
${imports.map(i => `  ${i.kind} ${i.module}.${i.name}`).join('\n') || '  None'}

<span class="info">Exports (${exports.length}):</span>
${exports.map(e => `  ${e.kind} ${e.name}`).join('\n') || '  None'}`;
                
                downloadBtn.disabled = false;
                runBtn.disabled = false;
                document.getElementById('runtime').innerHTML = '<span class="info">Ready to run! Click "Run WASM" to execute.</span>';
                
                console.log('Compiled WASM:', bytes);
                console.log('Imports:', imports);
                console.log('Exports:', exports);
                
            } catch (e) {
                output.innerHTML = `<span class="error">✗ Compilation error:\n${e}</span>`;
                console.error(e);
                lastCompiledBytes = null;
                downloadBtn.disabled = true;
                runBtn.disabled = true;
            }
        };
        
        // Run WASM function
        window.runWasm = async function() {
            if (!lastCompiledBytes) {
                document.getElementById('runtime').innerHTML = '<span class="error">No compiled WASM to run</span>';
                return;
            }
            
            const runtime = document.getElementById('runtime');
            const log = document.getElementById('log');
            
            // Clear previous log
            log.innerHTML = '';
            
            // Create import object with console.log support
            const importObject = {
                env: {
                    memory: new WebAssembly.Memory({ initial: 1 }),
                    console_log: (msg) => {
                        const entry = document.createElement('div');
                        entry.className = 'log-entry';
                        entry.innerHTML = `<span class="success">[console.log]</span> ${msg}`;
                        log.appendChild(entry);
                        console.log('[WASM console.log]:', msg);
                    }
                }
            };
            
            try {
                runtime.innerHTML = '<span class="info">Instantiating WASM module...</span>';
                
                const wasmModule = await WebAssembly.compile(lastCompiledBytes);
                wasmInstance = await WebAssembly.instantiate(wasmModule, importObject);
                
                // Display available exports
                const exports = Object.keys(wasmInstance.exports);
                let runtimeHtml = `<span class="success">✓ WASM module instantiated!</span>

<span class="info">Available exports:</span>
${exports.map(e => `  • ${e}`).join('\n')}

<span class="info">Execution results:</span>`;
                
                // Auto-call functions
                for (const name of exports) {
                    const fn = wasmInstance.exports[name];
                    if (typeof fn === 'function') {
                        try {
                            const result = fn();
                            runtimeHtml += `\n  ${name}() = <span class="success">${result}</span>`;
                            
                            // Also log it
                            const entry = document.createElement('div');
                            entry.className = 'log-entry';
                            entry.innerHTML = `<span class="info">[call]</span> ${name}() → <span class="success">${result}</span>`;
                            log.appendChild(entry);
                        } catch (e) {
                            runtimeHtml += `\n  ${name}() = <span class="error">Error: ${e.message}</span>`;
                        }
                    }
                }
                
                runtime.innerHTML = runtimeHtml;
                
            } catch (e) {
                runtime.innerHTML = `<span class="error">✗ Runtime error:\n${e.message}</span>`;
                console.error(e);
            }
        };
        
        // Download WASM file
        window.downloadWasm = function() {
            if (!lastCompiledBytes) return;
            
            const blob = new Blob([lastCompiledBytes], { type: 'application/wasm' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'output.wasm';
            a.click();
            URL.revokeObjectURL(url);
        };
        
        // Clear log
        window.clearLog = function() {
            document.getElementById('log').innerHTML = '<span class="info">Execution log cleared.</span>';
        };
        
        // Load examples
        window.loadExample = function(name) {
            const examples = {
                simple: `export i32 main() {
    return 42;
}`,
                refs: `// Test externref with console.log
memory 1;

extern void console_log(externref msg);

export i32 test_refs() {
    externref null_ref = ref.null externref;
    
    if (ref.is_null(null_ref)) {
        return 1;
    }
    
    return 0;
}

export i32 main() {
    return test_refs();
}`,
                console: `// Call JavaScript console.log from WASM
memory 1;

extern void console_log(externref msg);

export void greet() {
    console_log("Hello from WASM!");
    console_log("The current time is: ");
}

export i32 main() {
    greet();
    return 0;
}`,
                add: `// Simple add function
export i32 add(i32 a, i32 b) {
    return a + b;
}

export i32 main() {
    return add(10, 32);
}`
            };
            
            document.getElementById('source').value = examples[name] || examples.simple;
            
            // Auto-compile when loading example
            window.compile();
        };
        
        // Initialize
        initWasm();
    </script>
</body>
</html>
