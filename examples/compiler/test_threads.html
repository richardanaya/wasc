<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WASC Thread Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 900px;
            margin: 50px auto;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
        }
        h1 { color: #4ec9b0; }
        h2 { color: #569cd6; margin-top: 30px; }
        .panel {
            background: #252526;
            border: 1px solid #3e3e42;
            padding: 20px;
            margin: 20px 0;
            border-radius: 5px;
        }
        button {
            background: #0e639c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        button:hover { background: #1177bb; }
        button:disabled { background: #3e3e42; cursor: not-allowed; }
        .success { color: #4ec9b0; }
        .error { color: #f48771; }
        .info { color: #569cd6; }
        .warning { color: #dcdcaa; }
        pre {
            background: #1e1e1e;
            padding: 15px;
            border-radius: 3px;
            overflow-x: auto;
            border: 1px solid #3e3e42;
            font-size: 13px;
        }
        #log {
            max-height: 400px;
            overflow-y: auto;
            background: #1e1e1e;
            padding: 10px;
            border: 1px solid #3e3e42;
            font-family: 'Consolas', monospace;
            font-size: 13px;
            line-height: 1.6;
        }
        .log-entry { 
            margin: 5px 0; 
            padding: 8px; 
            border-left: 3px solid #4ec9b0; 
            background: #2d2d30;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 3px;
            background: #2d2d30;
        }
    </style>
</head>
<body>
    <h1>WASC Thread & Atomic Operations Test</h1>
    
    <div class="panel">
        <h3>Environment Check</h3>
        <div id="envCheck" class="status">Checking...</div>
    </div>

    <div class="panel">
        <h3>Test 1: Simple Atomic Add</h3>
        <pre>memory shared 1;
export i32 main() {
    i32 ptr = 0;
    i32 old = atomic.add(ptr, 42);
    return old;
}</pre>
        <button onclick="runTest('atomic')" id="btn-atomic">Run Atomic Test</button>
        <div id="result-atomic"></div>
    </div>

    <div class="panel">
        <h3>Test 2: Thread Notify</h3>
        <pre>memory shared 1;
export i32 main() {
    i32 ptr = 0;
    i32 woken = thread.notify(ptr, 1);
    return woken;
}</pre>
        <button onclick="runTest('notify')" id="btn-notify">Run Notify Test</button>
        <div id="result-notify"></div>
    </div>

    <div class="panel">
        <h3>Test 3: Thread Wait (0 timeout = non-blocking)</h3>
        <pre>memory shared 1;
export i32 main() {
    i32 ptr = 0;
    i32 expected = 0;
    i32 timeout = 0;  // Don't block
    i32 result = thread.wait32(ptr, expected, timeout);
    return result;
}</pre>
        <button onclick="runTest('wait')" id="btn-wait">Run Wait Test</button>
        <div id="result-wait"></div>
    </div>

    <div class="panel">
        <h3>Test 4: Full Sequence</h3>
        <pre>memory shared 1;
export i32 main() {
    i32 ptr = 0;
    atomic.store(ptr, 100);
    i32 val = atomic.load(ptr);
    i32 old = atomic.add(ptr, 50);
    return old + val;
}</pre>
        <button onclick="runTest('sequence')" id="btn-sequence">Run Sequence Test</button>
        <div id="result-sequence"></div>
    </div>

    <div class="panel">
        <h3>Execution Log</h3>
        <div id="log"></div>
    </div>

    <script type="module">
        import init, { compile_wasm } from './wasc.js';
        
        const tests = {
            atomic: `memory shared 1;
export i32 main() {
    i32 ptr = 0;
    i32 old = atomic.add(ptr, 42);
    return old;
}`,
            notify: `memory shared 1;
export i32 main() {
    i32 ptr = 0;
    i32 woken = thread.notify(ptr, 1);
    return woken;
}`,
            wait: `memory shared 1;
export i32 main() {
    i32 ptr = 0;
    i32 expected = 0;
    i32 timeout = 0;
    i32 result = thread.wait32(ptr, expected, timeout);
    return result;
}`,
            sequence: `memory shared 1;
export i32 main() {
    i32 ptr = 0;
    atomic.store(ptr, 100);
    i32 val = atomic.load(ptr);
    i32 old = atomic.add(ptr, 50);
    return old + val;
}`
        };
        
        function log(msg, type = 'info') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            const time = new Date().toLocaleTimeString();
            entry.innerHTML = `<span class="${type}">[${time}] ${msg}</span>`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${type}] ${msg}`);
        }
        
        // Check environment
        function checkEnvironment() {
            const envDiv = document.getElementById('envCheck');
            let html = '';
            
            // Check SharedArrayBuffer
            try {
                new SharedArrayBuffer(1);
                html += '<span class="success">✓ SharedArrayBuffer available</span><br>';
            } catch (e) {
                html += '<span class="error">✗ SharedArrayBuffer NOT available</span><br>';
                html += '<span class="warning">⚠ COOP/COEP headers missing</span><br>';
            }
            
            // Check Atomics
            if (typeof Atomics !== 'undefined') {
                html += '<span class="success">✓ Atomics API available</span><br>';
            } else {
                html += '<span class="error">✗ Atomics API NOT available</span><br>';
            }
            
            // Check WebAssembly
            if (typeof WebAssembly !== 'undefined') {
                html += '<span class="success">✓ WebAssembly available</span><br>';
            } else {
                html += '<span class="error">✗ WebAssembly NOT available</span><br>';
            }
            
            envDiv.innerHTML = html;
        }
        
        async function initWasm() {
            try {
                log('Initializing WASC compiler...');
                await init();
                log('✓ WASC compiler loaded', 'success');
                checkEnvironment();
            } catch (e) {
                log('✗ Error loading compiler: ' + e.message, 'error');
                console.error(e);
            }
        }
        
        window.runTest = async function(testName) {
            const resultDiv = document.getElementById(`result-${testName}`);
            const btn = document.getElementById(`btn-${testName}`);
            
            resultDiv.innerHTML = '<span class="info">Running...</span>';
            btn.disabled = true;
            
            try {
                log(`\\n=== Starting ${testName} test ===`);
                
                // Compile
                const source = tests[testName];
                log('Compiling source code...');
                
                let bytes;
                try {
                    bytes = compile_wasm(source);
                } catch (compileErr) {
                    throw new Error('Compilation failed: ' + compileErr);
                }
                
                log(`✓ Compiled ${bytes.length} bytes`, 'success');
                
                // Log byte hex preview
                const hexPreview = Array.from(bytes.slice(0, 16))
                    .map(b => b.toString(16).padStart(2, '0'))
                    .join(' ');
                log(`Hex: ${hexPreview}...`);
                
                // Create shared memory
                log('Creating shared memory...');
                let memory;
                try {
                    memory = new WebAssembly.Memory({ 
                        initial: 1, 
                        maximum: 1,
                        shared: true
                    });
                    log('✓ Shared memory created', 'success');
                } catch (memErr) {
                    throw new Error('Failed to create shared memory: ' + memErr.message);
                }
                
                // Compile WASM module
                log('Compiling WASM module...');
                let wasmModule;
                try {
                    wasmModule = await WebAssembly.compile(bytes);
                    log('✓ WASM module compiled', 'success');
                } catch (compileErr) {
                    throw new Error('WASM compilation failed: ' + compileErr.message);
                }
                
                // Get imports
                const imports = WebAssembly.Module.imports(wasmModule);
                log(`Module imports: ${imports.length > 0 ? imports.map(i => i.name).join(', ') : 'none'}`);
                
                // Get exports
                const exports = WebAssembly.Module.exports(wasmModule);
                log(`Module exports: ${exports.map(e => e.name).join(', ')}`);
                
                // Instantiate
                log('Instantiating WASM module...');
                let instance;
                try {
                    instance = await WebAssembly.instantiate(wasmModule, {
                        env: { memory }
                    });
                    log('✓ Module instantiated', 'success');
                } catch (instErr) {
                    throw new Error('Instantiation failed: ' + instErr.message);
                }
                
                // Run main
                if (!instance.exports.main) {
                    throw new Error('No main() export found');
                }
                
                log('Calling main()...');
                let result;
                try {
                    result = instance.exports.main();
                    log(`✓ main() returned: ${result}`, 'success');
                    resultDiv.innerHTML = `<span class="success">✓ SUCCESS! main() returned ${result}</span>`;
                } catch (runErr) {
                    throw new Error('Runtime error: ' + runErr.message);
                }
                
                // Check memory if atomic test
                if (testName === 'atomic' || testName === 'sequence') {
                    const memVal = new Int32Array(memory.buffer)[0];
                    log(`Memory[0] = ${memVal} (should be ${testName === 'atomic' ? 42 : 150})`);
                }
                
                log(`=== ${testName} test completed ===\\n`);
                
            } catch (e) {
                log('✗ ' + e.message, 'error');
                console.error(e);
                resultDiv.innerHTML = `<span class="error">✗ FAILED: ${e.message}</span>`;
            } finally {
                btn.disabled = false;
            }
        };
        
        // Initialize
        initWasm();
    </script>
</body>
</html>
